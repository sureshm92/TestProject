<!-- Author leonid Bartenev -->
<project name="Deployment script" basedir="." xmlns:sf="antlib:com.salesforce">

    <property file="build.properties"/>
    <property environment="env"/>

    <taskdef resource="com/salesforce/antlib.xml" uri="antlib:com.salesforce">
        <classpath>
            <pathelement location="${ant.salesforce.lib}"/>
        </classpath>
    </taskdef>

    <taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask">
        <classpath>
            <pathelement location="${ant.xmltask.lib}"/>
        </classpath>
    </taskdef>

    <!-- targets: -->

    <target name="deploy-int" depends="prepare-metadata">
        <sf:deploy username="${sf.int.username}"
                   password="${sf.int.password}"
                   serverurl="${sf.serverurl}"
                   maxPoll="${sf.maxPoll}"
                   deployRoot="${source.dir}"
                   pollwaitmillis="${sf.maxPollWaitTimeMs}"
                   rollbackOnError="true">
        </sf:deploy>
    </target>

    <target name="validate-int" depends="prepare-metadata">
        <sf:deploy username="${sf.int.username}"
                   password="${sf.int.password}"
                   serverurl="${sf.serverurl}"
                   maxPoll="${sf.maxPoll}"
                   deployRoot="${source.dir}"
                   pollwaitmillis="${sf.maxPollWaitTimeMs}"
                   rollbackOnError="true" checkonly="true">
        </sf:deploy>
    </target>

    <target name="deploy-inf" depends="prepare-metadata">
        <sf:deploy username="${sf.inf.username}"
                   password="${sf.inf.password}"
                   serverurl="${sf.serverurl}"
                   maxPoll="${sf.maxPoll}"
                   deployRoot="${source.dir}"
                   pollwaitmillis="${sf.maxPollWaitTimeMs}"
                   rollbackOnError="true">
        </sf:deploy>
    </target>

    <target name="validate-inf" depends="prepare-metadata">
        <sf:deploy username="${sf.inf.username}"
                   password="${sf.inf.password}"
                   serverurl="${sf.serverurl}"
                   maxPoll="${sf.maxPoll}"
                   deployRoot="${source.dir}"
                   pollwaitmillis="${sf.maxPollWaitTimeMs}"
                   rollbackOnError="true" checkonly="true">
        </sf:deploy>
    </target>

    <!-- filter metadata files before deploy: -->
    <target name="prepare-metadata" depends="convert-project">
        <echo message="Start metadata filtration" level="info"/>
        <xmltask todir="${source.dir}/profiles">
            <fileset dir="${source.dir}/profiles"/>
            <remove path="/:Profile/:userPermissions[:name[text()='EnableCommunityAppLauncher']]"/>
            <remove path="/:Profile/:userPermissions[:name[text()='FieldServiceAccess']]"/>
            <remove path="/:Profile/:userPermissions[:name[text()='SendExternalEmailAvailable']]"/>
            <remove path="/:Profile/:applicationVisibilities[:application[text()='Developer']]"/>
        </xmltask>
        <echo message="Profiles filtered" level="info"/>
        <xmltask todir="${source.dir}/translations">
            <fileset dir="${source.dir}/translations"/>
            <remove path="/:Translations/:customApplications"/>
            <remove path="/:Translations/:customTabs"/>
            <remove path="/:Translations/:flowDefinitions"/>
            <remove path="/:Translations/:quickActions"/>
        </xmltask>
        <echo message="Translations filtered" level="info"/>
        <!-- temporary fix for deployment of Contact (remove Master record type from metadata): -->
        <xmltask source="${source.dir}/objects/Contact.object" dest="${source.dir}/objects/Contact.object">
            <remove path="/:CustomObject/:recordTypes[:fullName[text()='MASTER']]"/>
        </xmltask>
        <xmltask source="${source.dir}/package.xml" dest="${source.dir}/package.xml">
            <remove path="/:Package/:types/:members[text()='Contact.MASTER']"/>
        </xmltask>
        <echo message="Removed Contact.MASTER record type from metadata" level="info"/>
    </target>

    <target name="delete-spaces">
        <replaceregexp
                file="${dx.default.dir}/workflows/Participant_Enrollment__c.workflow-meta.xml"
                match="(\r?\n)\s*\r?\n"
                replace="\1"
                flags="g"
        />
        <echo message="replace" level="info"/>
    </target>


    <target name="convert-workflow-DX">
        <replace casesensitive="false"
                 file="${dx.default.dir}/workflows/Participant_Enrollment__c.workflow-meta.xml">
            <replacetoken><![CDATA[<senderType>OrgWideEmailAddress</senderType>]]></replacetoken>
            <replacevalue><![CDATA[<senderType>CurrentUser</senderType>]]></replacevalue>
        </replace>
        <echo message="replace completed" level="info"/>
    </target>

    <target name="convert-workflow-source">
        <replace casesensitive="false"
                 file="${dx.default.dir}/workflows/Participant_Enrollment__c.workflow-meta.xml">
            <replacetoken><![CDATA[<senderType>CurrentUser</senderType>]]></replacetoken>
            <replacevalue><![CDATA[<senderType>OrgWideEmailAddress</senderType>]]></replacevalue>
        </replace>
        <echo message="replace completed" level="info"/>
    </target>

    <target name="convert-project">
        <delete dir="${source.dir}"/>
        <exec dir=".." executable="cmd" osfamily="windows">
            <arg value="/c convert-project.bat"/>
        </exec>
        <!-- TODO test for mac -->
        <exec dir=".." executable="/bin/sh" osfamily="mac">
            <arg path="-c convert-project.bat"/>
        </exec>
    </target>

</project>
