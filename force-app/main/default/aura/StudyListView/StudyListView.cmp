<!--
 - Created by D.Yasinskyi on 08.02.2018.
 -->

<aura:component controller="StudyListViewController" description="StudyListView"
                implements="forceCommunity:availableForAllPageTypes">

    <ltng:require styles="{!join(',', $Resource.rr_community_css, $Resource.proximanova + '/proximanova.css')}"
                  scripts="{!join(',', $Resource.rr_community_js, $Resource.clamp_js)}"
                  afterScriptsLoaded="{!c.doInit}"/>


    <!-- Attributes: -->
    <aura:attribute name="userMode" type="String" access="private"/>
    <aura:attribute name="currentlyRecruitingTrials" type="List"/>
    <aura:attribute name="trialsNoLongerRecruiting" type="List"/>
    <aura:attribute name="showSpinner" type="Boolean" default="true" access="private"/>
    <aura:attribute name="currentTab" type="String" default="recruiting"/>
    <aura:attribute name="currentTrialId" type="String"/>
    <aura:attribute name="isInitialized" type="Boolean" default="false"/>
    <aura:attribute name="isSearchResume" type="Boolean" default="false"/>
    <aura:attribute name="peStatusesPathList" type="List"/>
    <aura:attribute name="peStatusStateMap" type="Map"/>

    <aura:attribute name="paginationData" type="Object"/>
    <aura:attribute name="filterData" type="Object"/>
    <aura:attribute name="sortData" type="Object"/>
    <aura:attribute name="currentPageList" type="List"/>
    <aura:attribute name="skipUpdate" type="Boolean" default="false" access="private"/>

    <aura:handler name="change" value="{!v.paginationData}" action="{!c.doUpdateRecords}"/>
    <aura:handler name="change" value="{!v.filterData}" action="{!c.doUpdateRecords}"/>
    <aura:handler name="change" value="{!v.sortData}" action="{!c.doUpdateRecords}"/>

    <!-- Handlers: -->
    <aura:handler event="c:EventCommunityInitialized" action="{!c.doInit}"/>

    <!-- Methods: -->
    <aura:method name="refresh" action="{!c.doInit}" access="public"/>
    <aura:method name="showOpenNoTanksModal" action="{!c.showNoThanksDialog}" access="public">
        <aura:attribute name="trialId" type="String"/>
    </aura:method>

    <!-- component body: -->
    <c:RRSpinner aura:id="mainSpinner" size="medium" showSpinner="{!v.showSpinner}" fixed="true"/>

    <aura:if isTrue="{!v.isInitialized}">
        <div class="{!v.isSearchResume ? 'slds-hide' : ''}">
            <c:RRNavigationPath>
                <c:RRNPathItem label="{!$Label.c.Home_Page_Label}"/>
            </c:RRNavigationPath>
        </div>
        <div class="{!v.isSearchResume ? '' : 'slds-hide'}">
            <c:RRNavigationPath>
                <c:RRNPathItem label="Studies" page=""/>
                <c:RRNPathItem label="Search for Studies"/>
            </c:RRNavigationPath>
        </div>

        <aura:if isTrue="{!v.userMode == 'HCP'}">
            <div>
                <c:FilterPanel searchText="{!v.filterData.searchText}"
                               searchTextPlaceHolder="{!v.isSearchResume ? 'Global Search for Study' : 'Search for Study'}"
                               recordsPerPage="{!v.paginationData.pageRecordsCount}"
                               recordsPerPageVariants="{!v.paginationData.recordCountVariants}"
                               sortType="{!v.sortData.sortType}"
                               sortVariants="{!v.sortData.sortVariants}"
                               allRecordsCount="{!v.paginationData.allRecordsCount}"
                               currentPageCount="{!v.paginationData.currentPageCount}"
                               itemTitle="studies">
                    <c:rrSelect value="{!v.filterData.enrollmentStatus}"
                                options="{!v.filterData.enrollmentStatuses}"
                                placeholder="Enrollment Status"
                                class="{!v.isSearchResume ? 'slds-hide' : ''}"/>
                    <c:rrSelect value="{!v.filterData.therapeuticArea}" options="{!v.filterData.therapeuticAreas}"
                                placeholder="Therapeutic Area"/>
                </c:FilterPanel>
            </div>

            <div class="slv-items-panel">
                <div class="{!(v.isSearchResume ? 'slds-hide' : '') + ' rr-simple-white-panel'}">
                    <div class="slds-grid slds-wrap slds-grid_align-center slds-grid_vertical-align-center" style="height: 100%;">
                        <div class="slds-col slds-medium-size_1-of-2 slds-size_1-of-1 slv-padded-panel-left slv-header-item">
                            <span class="header-white-panel">Don't see a study that you could refer your patients to?</span>
                        </div>
                        <div class="slds-col slds-medium-size_1-of-2 slds-size_1-of-1 slv-padded-panel-right slv-header-item">
                            <button class="apollo-btn primary search-more-btn" onclick="{!c.switchToSearchResume}">
                                Search for More Studies
                            </button>
                        </div>
                    </div>
                </div>

                <div style="position: relative; min-height: 100px;" class="slds-gutters_">
                    <c:RRSpinner aura:id="recordsSpinner" size="medium" showSpinner="false"/>
                    <aura:iteration items="{!v.currentPageList}" var="trial">
                        <c:StudyListViewItem searchItem="{!v.isSearchResume}" currentStudy="{!trial}"
                                             userMode="{!v.userMode}" parent="{!this}"/>
                    </aura:iteration>
                </div>
            </div>

            <div>
                <c:RRPaginationRemote entriesOnPage="{!v.paginationData.pageRecordsCount}"
                                      currentPage="{!v.paginationData.currentPage}"
                                      allRecordsCount="{!v.paginationData.allRecordsCount}"/>
            </div>
        </aura:if>

        <aura:if isTrue="{!v.userMode == 'PI'}">
            <div class="slv-items-panel">
                <!-- Output currently recruiting trials -->
                <aura:if isTrue="{!v.currentTab == 'recruiting'}">
                    <c:EmptyListStub targetList="{!v.currentlyRecruitingTrials}"/>
                    <aura:iteration items="{!v.currentlyRecruitingTrials}" var="trialsSubList">
                        <div class="slv-category">{!trialsSubList.name}</div>
                        <aura:iteration items="{!trialsSubList.studies}" var="trial">
                            <c:StudyListViewItem currentStudy="{!trial}" userMode="{!v.userMode}" parent="{!this}"/>
                        </aura:iteration>
                    </aura:iteration>
                </aura:if>

                <!-- Trials no longer recruiting -->
                <aura:if isTrue="{! v.currentTab == 'noLongerRecruiting'}">
                    <c:EmptyListStub targetList="{!v.trialsNoLongerRecruiting}"/>
                    <aura:if isTrue="{! !empty(v.trialsNoLongerRecruiting)}">
                        <div class="slv-category">{!$Label.c.PG_MRRL_L_Studies}</div>
                        <aura:iteration items="{!v.trialsNoLongerRecruiting}" var="trial">
                            <c:StudyListViewItem currentStudy="{!trial}" userMode="{!v.userMode}" parent="{!this}"/>
                        </aura:iteration>
                    </aura:if>
                </aura:if>
            </div>
        </aura:if>

        <aura:if isTrue="{!v.userMode == 'Participant'}">
            <aura:if isTrue="{! v.currentTab == 'recruiting'}">
                <c:EmptyListStub targetList="{!v.currentlyRecruitingTrials}"/>
                <aura:if isTrue="{! !empty(v.currentlyRecruitingTrials)}">
                    <div style="height: 30px"></div>
                    <aura:iteration items="{!v.currentlyRecruitingTrials}" var="pe">
                        <c:ViewPatientItem pe="{!pe}"
                                           peStatusesPathList="{!v.peStatusesPathList}"
                                           peStatusStateMap="{!v.peStatusStateMap}"
                                           changeStatusBtnList="{!v.changeStatusBtnList}"
                                           singlePatientView="true"/>
                    </aura:iteration>
                </aura:if>
            </aura:if>
            <aura:if isTrue="{! v.currentTab == 'noLongerRecruiting'}">
                <c:EmptyListStub targetList="{!v.trialsNoLongerRecruiting}"/>
                <aura:if isTrue="{! !empty(v.trialsNoLongerRecruiting)}">
                    <div style="height: 30px"></div>
                    <aura:iteration items="{!v.trialsNoLongerRecruiting}" var="pe">
                        <c:ViewPatientItem pe="{!pe}"
                                           peStatusesPathList="{!v.peStatusesPathList}"
                                           peStatusStateMap="{!v.peStatusStateMap}"
                                           changeStatusBtnList="{!v.changeStatusBtnList}"
                                           singlePatientView="true"/>
                    </aura:iteration>
                </aura:if>
            </aura:if>
        </aura:if>

        <!-- Reimbusment dialog -->
        <c:OpenToReceiveReferralsModal aura:id="receiveReferralsModal" parent="{!this}"/>

        <!-- No,thanks dialog -->
        <c:NoTanksModal aura:id="noTanksModal" trialId="{!v.currentTrialId}" parent="{!this}" userMode="{!v.userMode}"/>

        <!-- Share dialog -->
        <c:ShareModal aura:id="shareModal" parent="{!this}"/>
    </aura:if>

</aura:component>