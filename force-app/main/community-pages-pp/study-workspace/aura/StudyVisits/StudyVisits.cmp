<!--
 - Created by Igor Malyuta on 12.04.2019.
 -->

<aura:component description="StudyVisits" controller="ParticipantVisitsRemote">

    <ltng:require scripts="{!join(',', $Resource.rr_community_js)}" afterScriptsLoaded="{!c.doInit}"/>

    <!--attributes-->
    <aura:attribute name="visitWrappers" type="PatientVisitService.VisitWrapper[]"/>
    <aura:attribute name="currentVisits" type="PatientVisitService.VisitWrapper[]"/>
    <aura:attribute name="initialized" type="Boolean" default="false"/>
    <aura:attribute name="visitModeCurrent" type="String" access="private" default="Current"/>
    <aura:attribute name="visitMode" type="String" default="All"/>
    <aura:attribute name="options" type="List"/>
    <aura:attribute name="iconNames" type="String" default=""/>
    <aura:attribute name="isHasVisits" type="Boolean" default="true"/>
    <aura:attribute name="visitPlanAvailable" type="Boolean" default="true"/>

    <!--HANDLERS-->
    <aura:handler name="change" value="{!v.visitMode}" action="{!c.getVisits}"/>

    <c:RRSpinner aura:id="spinner" size="medium" showSpinner="true" fixed="true"/>

    <div class="{!'sv-body ' + if(v.initialized, '', 'hidden')}">
        <div class="tt-title">
            {!$Label.c.Home_Page_StudyVisit_Title}
        </div>
        <div class="select-container">{!$Label.c.Home_Page_StudyVisit_Show_Filter_Visits}
            <c:rrSelect value="{!v.visitMode}" options="{!v.options}" setValueAsSelected="All" class="select-list"
                        iconColor="#666666"/>
        </div>

        <aura:if isTrue="{!v.visitPlanAvailable}">
            <ui:scrollerWrapper>
                <aura:if isTrue="{!!empty(v.visitWrappers)}">
                    <c:RRTable>
                        <tr>
                            <th class="sv-t-name">{!$Label.c.Home_Page_StudyVisit_Visit}</th>
                            <th class="sv-t-time">{!$Label.c.Home_Page_StudyVisit_Schedule}</th>
                            <th class="sv-t-icons">{!or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All') ? $Label.c.Home_Page_StudyVisit_WhToEx : $Label.c.Home_Page_StudyVisit_What_Took_Place}</th>
                            <th class="{!or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All') ? 'sv-t-status' : 'invisible'}">{!$Label.c.Home_Page_StudyVisit_Status}</th>
                            <th class="{!or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All') ? '' : 'invisible'}">{!$Label.c.Home_Page_StudyVisit_Reminder}</th>
                            <th class="{!or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All') ? 'invisible' : 'sv-t-completed-date'}">{!$Label.c.Home_Page_StudyVisit_Completed_On}</th>
                        </tr>
                        <aura:iteration var="visitWrapper" items="{!v.currentVisits}">
                            <tr>
                                <td class="sv-t-name">{!(visitWrapper.visit.Is_Adhoc__c
                                    ? $Label.c.StudyVisit_Unscheduled_Visit
                                    : visitWrapper.visit.Visit__r.Patient_Portal_Name__c)}</td>
                                <td class="sv-t-time">{!(visitWrapper.visit.Is_Adhoc__c ? $Label.c.StudyVisit_Ad_hoc_Visit : visitWrapper.visit.Visit__r.Visit_Schedule__c)}</td>
                                <td class="{!visitWrapper.visit.Is_Adhoc__c ? 'invisible' : 'sv-t-icons'}">
                                    <c:RRIconSplitter numOfIconsToDisplay="50" class="svl-icon"
                                                      value="{!visitWrapper.icons}"/>
                                </td>
                                <td class="{!visitWrapper.visit.Is_Adhoc__c ? 'sv-t-icons' : 'invisible'}">{!$Label.c.StudyVisit_Variable}</td>
                                <td class="{!or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All') ? 'sv-t-status' : 'invisible'}">{!visitWrapper.visit.Status__c}</td>
                                <aura:if isTrue="{!and(or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All'), visitWrapper.visit.Status__c == 'Completed')}"><td></td></aura:if>
                                <td class="{!and(or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All'), visitWrapper.visit.Status__c != 'Completed') ? 'sv-t-reminder' : 'invisible'}"
                                    data-visit-id="{!visitWrapper.visit.Id}"
                                    data-task-id="{!visitWrapper.task.Id}"
                                    onclick="{!c.createEditTask}">
                                    <aura:if isTrue="{!visitWrapper.task == null}">
                                        {!$Label.c.Create}
                                        <aura:set attribute="else">
                                            <aura:if isTrue="{!visitWrapper.task.ReminderDateTime == null}">
                                                {!$Label.c.Home_Page_StudyVisit_No_Reminder_Date}
                                                <aura:set attribute="else">
                                                    <ui:outputDate value="{!visitWrapper.reminderDate}"/>
                                                </aura:set>
                                            </aura:if>
                                        </aura:set>
                                    </aura:if>
                                </td>
                                <td class="{!or(v.visitMode == v.visitModeCurrent, v.visitMode == 'All') ? 'invisible' : 'sv-t-completed-date'}">{!visitWrapper.completedDate}</td>
                            </tr>
                        </aura:iteration>
                    </c:RRTable>
                    <div class="pagination">
                        <c:rrPagination allObjects="{!v.visitWrappers}" currentObjects="{!v.currentVisits}"
                                        entriesOnPage="4"/>
                    </div>
                </aura:if>

                <c:EmptyListStub class="no-visits-message" targetList="{!v.visitWrappers}" iconName="none"
                                 message="{!$Label.c.PG_VP_L_No_Items_display}"/>
            </ui:scrollerWrapper>


            <aura:if isTrue="{!v.initialized}">
                <c:StudyVisitsLegend iconNames="{!v.iconNames}"/>
            </aura:if>
            <aura:set attribute="else">
                <div class="error-message">{!$Label.c.PG_VP_L_No_Items_display}</div>
            </aura:set>
        </aura:if>
    </div>
</aura:component>