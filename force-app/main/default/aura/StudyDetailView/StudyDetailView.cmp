<!--
 - Created by D.Yasinskyi on 21.02.2018.
 -->

<aura:component controller="StudyDetailViewController" implements="forceCommunity:availableForAllPageTypes"
                description="StudyDetailView">
    <ltng:require styles="{!join(',', $Resource.rr_community_css, $Resource.proximanova + '/proximanova.css')}"
                  scripts="{!join(',', $Resource.rr_community_js)}"/>

    <!-- attributes: -->
    <aura:attribute name="studyDetail" type="StudyDetailViewController.TrialDetail"/>
    <aura:attribute name="userMode" type="String" description="HCP / PI / Participant"/>
    <aura:attribute name="state" type="String" description="ALUMNI, PROSPECT, REFERRAL, PARTICIPANT"/>
    <aura:attribute name="currentTab" type="String" default="tab-about-the-study"/>
    <aura:attribute name="currentActions" type="List"/>
    <aura:attribute name="shareButtons" type="List"/>
    <aura:attribute name="multiMode" type="Boolean"/>
    <aura:attribute name="isInitialized" type="Boolean" default="false"/>

    <aura:attribute name="isReportsTabInitialized" type="Boolean"/>
    <aura:attribute name="isReferralsTabInitialized" type="Boolean"/>
    <aura:attribute name="isReferringClinicsTabInitialized" type="Boolean"/>
    <aura:attribute name="isStudySitesTabInitialized" type="Boolean"/>
    <aura:attribute name="isMRRTabInitialized" type="Boolean"/>
    <aura:attribute name="isReferredPatientsTabInitialized" type="Boolean"/>

    <!--change-->
    <aura:attribute name="resourceImagePath" type="String" access="private"/>
    <aura:attribute name="resourceMode" type="String" default="Default"/>
    <aura:attribute name="taskMode" type="String" default="Open"/>
    <aura:attribute name="isShare" type="Boolean"/>
    <aura:attribute type="String" name="shareMessage"/>

    <!-- handlers: -->
    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>
    <aura:handler event="c:EventCommunityInitialized" action="{!c.doInit}"/>
    <aura:handler name="change" value="{!v.currentTab}" action="{!c.doTabChanged}"/>
    <aura:handler name="change" value="{!v.taskMode}" action="{!c.doTabChanged}"/>
    <aura:handler name="change" value="{!v.resourceMode}" action="{!c.doTabChanged}"/>

    <!-- methods: -->
    <aura:method name="refresh" action="{!c.doInit}" access="public"/>

    <!-- component body -->
    <c:RRSpinner aura:id="mainSpinner" size="medium" fixed="true"/>
    <div>
        <aura:if isTrue="{!v.isInitialized}">
            <!-- Share dialog -->
            <c:ShareModal aura:id="shareModal" parent="{!this}" needRefresh="false"/>
            <!-- top bar -->
            <div class="{!'sdv-top-bar ' + if(v.multiMode, 'multi-mode', '')}" id="stickyBar" aura:id="stickyBar">
                <div class="navigation rr-width-limiter side-padding">
                    <aura:if isTrue="{!v.userMode == 'Participant'}">
                        <aura:if isTrue="{!v.state != 'ALUMNI'}">
                            <c:RRNavigationPath>
                                <c:RRNPathItem label="{!$Label.c.Navigation_Home}" page=""/>
                                <c:RRNPathItem label="{!$Label.c.PG_SW_Title}"/>
                            </c:RRNavigationPath>
                            <aura:if isTrue="{!!empty(v.studyDetail.trial.Profile_Picture__c)}">
                                <div class="rr-width-limiter">
                                    <img class="contrast-logo" src="{!v.studyDetail.trial.Profile_Picture__c}"/>
                                </div>
                            </aura:if>
                            <aura:if isTrue="{!empty(v.studyDetail.trial.Profile_Picture__c)}">
                                <div class="title rr-width-limiter side-padding">{!v.studyDetail.trial.Official_Title__c}</div>
                            </aura:if>
                        </aura:if>
                        <aura:if isTrue="{!v.state == 'ALUMNI'}">
                            <c:RRNavigationPath>
                                <c:RRNPathItem label="{!$Label.c.Navigation_Home}" page=""/>
                                <c:RRNPathItem label="{!$Label.c.PG_RW_Title}"/>
                            </c:RRNavigationPath>
                            <div class="rr-width-limiter">
                                <img class="contrast-logo" src="{!$Resource.PH_logo + '/iqvia.png'}"/>
                            </div>
                        </aura:if>
                    </aura:if>
                    <aura:if isTrue="{!v.userMode != 'Participant'}">
                        <c:RRNavigationPath>
                            <c:RRNPathItem label="{!$Label.c.Home_Page_Label}" page=""/>
                            <c:RRNPathItem label="{!$Label.c.PG_SW_Title}"/>
                        </c:RRNavigationPath>
                        <div class="title rr-width-limiter side-padding">{!v.studyDetail.trial.Official_Title__c}</div>
                    </aura:if>
                </div>

                <div class="rr-all-content sticky-bar" id="stickyPositionTarget">
                    <c:RRAnchor aura:id="tabsTarget"/>
                    <aura:if isTrue="{!!empty(v.studyDetail.tabs)}">
                        <div class="tabs">
                        <div class="rr-width-limiter">
                                <c:RRTabSet>
                                    <!-- tabs: -->
                                    <aura:set attribute="floatPositionLeft">
                                        <aura:if isTrue="{!v.userMode != 'HCP'}">
                                            <aura:iteration items="{!v.studyDetail.tabs}" var="tab">
                                                <c:RRTabSetItem tabId="{!tab.id}" currentTab="{!v.currentTab}"
                                                                iconName="{!tab.iconName}" title="{!tab.title}"
                                                                studyId="{!v.studyDetail.trial.Id}"/>
                                            </aura:iteration>
                                        </aura:if>
                                    </aura:set>
                                    <!-- action buttons: -->
                                    <aura:set attribute="floatPositionRight">
                                        <div class="actions-buttons">
                                            <aura:iteration items="{!v.currentActions}" var="action">
                                                <div style="position: relative;">
                                                    <aura:if isTrue="{!action.id != 'share'}">
                                                        <button class="{!'apollo-btn text ico-in-top small-font sdv-btn'}"
                                                                disabled="{!action.disabled}" id="{!action.id}"
                                                                onclick="{!c.doAction}" title="{!action.disableReason}">
                                                            <c:RRIcon iconName="{!action.iconName}"/>
                                                            {!action.label}
                                                        </button>
                                                    </aura:if>
                                                    <aura:if isTrue="{!and(action.id == 'share',!empty(v.studyDetail.trial.NCT_Number__c))}">
                                                        <div class="share-icons">
                                                            <aura:iteration items="{!v.shareButtons}" var="shareButton">
                                                                <div class="share-ico" id="{!shareButton.id}" onclick="{!c.doAction}">
                                                                    <c:RRIcon iconName="{!shareButton.iconName}"/>
                                                                </div>
                                                            </aura:iteration>
                                                        </div>
                                                    </aura:if>
                                                </div>
                                            </aura:iteration>
                                        </div>
                                    </aura:set>
                                </c:RRTabSet>
                        </div>
                    </div>
                    </aura:if>
                    <div class="{!'links rr-width-limiter side-padding' + if(v.currentTab == 'tab-about-the-study', '', ' collapsed')}">
                        <button class="apollo-btn text" data-anchor="aboutAnchor"
                                onclick="{!c.doScrollInto}">{!$Label.c.PG_SW_Link_About_The_Study}</button>
                        <button class="apollo-btn text" data-anchor="inclusionExclusionAnchor"
                                onclick="{!c.doScrollInto}">{!$Label.c.PG_SW_Link_Inclusion_Exclusion_Criteria}</button>
                        <!-- HCP -->
                        <!--<aura:if isTrue="{!v.userMode == 'HCP'}">
                            <button class="apollo-btn text" data-anchor="studySitesAnchor" onclick="{!c.doScrollInto}">{!$Label.c.PG_VP_L_Study_sites}</button>

                        </aura:if> -->
                        <aura:if isTrue="{!v.userMode == 'Participant'}">
                            <button class="apollo-btn text" data-anchor="studySiteAnchor" onclick="{!c.doScrollInto}">{!$Label.c.PG_VP_L_Study_site}</button>
                        </aura:if>
                        <!-- PI -->
                        <aura:if isTrue="{!v.userMode == 'PI'}">
                            <button class="apollo-btn text" data-anchor="referringClinicsAnchor" onclick="{!c.doScrollInto}">{!$Label.c.PG_DBPI_L_Referring_clinics}</button>
                        </aura:if>
                    </div>

                    <div class="{!'links rr-width-limiter side-padding' + if(v.currentTab == 'tab-tasks', '', ' collapsed')}">
                        <button id="changeTaskMode" data-task-mode="Open" value="Pending"
                                class="{!'apollo-btn text ' + if(v.taskMode == 'Open', ' current', '')}"
                                onclick="{!c.doAction}">{!$Label.c.Task_Tab_Open_Tasks}</button>
                        <button id="changeTaskMode" data-task-mode="Completed" value="Pending"
                                class="{!'apollo-btn text ' + if(v.taskMode == 'Completed', ' current', '')}"
                                onclick="{!c.doAction}">{!$Label.c.Task_Tab_Completed_Tasks}</button>
                    </div>

                    <div class="{!'links rr-width-limiter side-padding' + if(v.currentTab == 'tab-resources', '', ' collapsed')}">
                        <aura:if isTrue="{!v.state != 'ALUMNI'}">
                            <button id="changeResourceMode" data-resource-mode="Documents"
                                    class="{!'apollo-btn text ' + if(v.resourceMode == 'Documents', ' current', '')}"
                                    onclick="{!c.doAction}">{!$Label.c.Resource_Tab_Study_Documents}</button>
                        </aura:if>
                        <button id="changeResourceMode" data-resource-mode="Default"
                                class="{!'apollo-btn text ' + if(v.resourceMode == 'Default', ' current', '')}"
                                onclick="{!c.doAction}">{!$Label.c.Resource_Tab_Study_Video_And_Articles}</button>
                        <button id="changeResourceMode" data-resource-mode="Favorite"
                                class="{!'apollo-btn text ' + if(v.resourceMode == 'Favorite', ' current', '')}"
                                onclick="{!c.doAction}">{!$Label.c.Resource_Tab_Favorites}</button>
                    </div>

                </div>
                <!-- Stub visible only when sticky bar fixed-->
                <div>
                    <div class="height-stub" style="height: 62px"></div>
                    <aura:if isTrue="{!v.currentTab == 'tab-about-the-study'}">
                        <div class="height-stub" style="height: 40px"></div>
                    </aura:if>
                </div>
            </div>

            <div id="sd-selected-tab-container" style="position: relative">
                <div class="rr-width-limiter side-padding rr-min-body-height">
                    <div class="{!if(v.currentTab == 'tab-about-the-study', 'visible-tab', 'invisible-tab')}">
                        <c:StudyDetailAboutStudy studyDetail="{!v.studyDetail}" userMode="{!v.userMode}"
                                                 parent="{!this}"/>
                    </div>

                    <aura:if isTrue="{!v.isReferringClinicsTabInitialized}">
                        <div class="{!if(v.currentTab == 'tab-referred-clinics', 'visible-tab', 'invisible-tab')}">
                            <c:MyReferringClinics/>
                        </div>
                    </aura:if>

                    <aura:if isTrue="{!v.isStudySitesTabInitialized}">
                        <div class="{!if(v.currentTab == 'tab-referred-study-sites', 'visible-tab', 'invisible-tab')}">
                            <c:MyStudySites/>
                        </div>
                    </aura:if>

                    <aura:if isTrue="{!v.isReferredPatientsTabInitialized}">
                        <div class="{!if(v.currentTab == 'tab-referred-patients', 'visible-tab', 'invisible-tab')}">
                            <c:ViewPatients trialId="{!v.studyDetail.trial.Id}" parent="{!this}"/>
                        </div>
                    </aura:if>

                    <!--                    <aura:if isTrue="{!v.isMRRTabInitialized}">-->
                    <!--                        <div class="{!if(v.currentTab == 'tab-medical-record-review-log', 'visible-tab', 'invisible-tab')}">-->
                    <!--                            <c:MedicalRecordReviewLog showStatistics="false"/>-->
                    <!--                        </div>-->
                    <!--                    </aura:if>-->

                    <aura:if isTrue="{!v.isReferralsTabInitialized}">
                        <div class="{!if(v.currentTab == 'tab-referrals', 'visible-tab', 'invisible-tab')}">
                            <c:ViewPatientsReferred trialId="{!v.studyDetail.trial.Id}" parent="{!this}"/>
                        </div>
                    </aura:if>

                    <aura:if isTrue="{!v.currentTab == 'tab-reports'}">
                        <c:Reports trialId="{!v.studyDetail.trial.Id}"/>
                    </aura:if>

                    <aura:if isTrue="{!v.currentTab == 'tab-visits'}">
                        <c:StudyVisits/>
                    </aura:if>

                    <aura:if isTrue="{!v.currentTab == 'tab-tasks'}">
                        <c:TasksTab taskMode="{!v.taskMode}"/>
                    </aura:if>

                    <aura:if isTrue="{!v.currentTab == 'tab-resources'}">
                        <c:ResourceContainer resourceMode="{!v.resourceMode}"/>
                    </aura:if>

                    <aura:if isTrue="{!v.currentTab == 'tab-lab-results'}">
                        {!v.currentTab}
                    </aura:if>
                </div>
            </div>

        </aura:if>
    </div>

</aura:component>