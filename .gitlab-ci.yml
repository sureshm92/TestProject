stages:
- deployINT
- validateINT
- validateINF
- deployINF
- runTestINF
- runTestINT
- VALIDATE
- DEPOLOY_DRYRUN
cache:
  paths:
  - node_modules
  - ~/.sfdx
  - .sfdx
VALIDATE_DRYRUN:
  tags:
  - shell_2
  only:
  - PH_R1_Sprint
  - Sprint
  - merge_requests
  except:
  - push
  - commit

  stage: VALIDATE
  script:
  - echo "$SFDX_AUTH_URL_DRY_RUN" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a DRYRUN -d
  - sfdx --version
  - cd Nodejs
  - node convert.js
  - cd ..
  - rm -rf output
  - sfdx force:source:convert -d output
  - sfdx force:mdapi:deploy -d output -u DRYRUN -c --testlevel=RunLocalTests -w 60
  - echo "validate Int success"

VALIDATE_INF:
  tags:
  - shell
  only:
  - Informal
  - merge_requests
  except:
  - push
  - commit

  stage: VALIDATE
  script:
  - echo "$SFDX_AUTH_URL_INF" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a INF -d
  - sfdx --version
  - cd Nodejs
  - node convert.js
  - cd ..
  - rm -rf output
  - sfdx force:source:convert -d output
  - sfdx force:mdapi:deploy -d output -u INF -c -w 60
  - echo "validate Inf success"

VALIDATE_INT:
  tags:
  - shell
  only:
  - merge_requests
  except:
  - push
  - commit

  stage: VALIDATE
  script:
  - echo "$SFDX_AUTH_URL_INF" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a INT -d
  - sfdx --version
  - cd Nodejs
  - node convert.js
  - cd ..
  - rm -rf output
  - sfdx force:source:convert -d output
  - sfdx force:mdapi:deploy -d output -u INT -c -w 60
  - echo "validate Inf success"


DEPOLOY_DRYRUN:
  tags:
  - shell_2
  only:
  - PH_R1_Sprint
  except:
  - merge_requests

  stage: DEPOLOY_DRYRUN
  script:
  - echo "$SFDX_AUTH_URL_DRY_RUN" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a DRYRUN -d
  - sfdx --version
  - cd Nodejs
  - node convert.js
  - cd ..
  - rm -rf output
  - sfdx force:source:convert -d output
  - sfdx force:mdapi:deploy -d output -u DRYRUN  -w 60
  - echo "validate Int success"


deployINT:
  tags:
  - shell
  only:
  - Sprint
  except:
  - merge_requests

  stage: deployINT
  script:
  - echo "$SFDX_AUTH_URL" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a INT -d
  - echo "test1"
  - sfdx --version
  - cd Nodejs
  - node convert.js
  - cd ..
  - rm -rf output
  - sfdx force:source:convert -d output
  - sfdx force:mdapi:deploy -d output -u INT  -w 60
  - echo "deploy Int success"

DeployINF:
  tags:
  - shell
  only:
  - Informal
  except:
  - merge_requests

  stage: deployINF
  script:
  - echo "$SFDX_AUTH_URL_INF" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a INF -d
  - sfdx --version
  - cd Nodejs
  - node convert.js
  - cd ..
  - rm -rf output
  - sfdx force:source:convert -d output
  - sfdx force:mdapi:deploy -d output -u INF  -w 60
  - echo "deploy Inf success"

runTestINT:
  tags:
  - shell
  only:
  - Sprint
  except:
  - merge_requests

  stage: runTestINT
  script:
  - echo "$SFDX_AUTH_URL" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a INT -d
  - sfdx force:apex:test:run -u INT --testlevel=RunLocalTests -w 60

runTestINF:
  tags:
  - shell
  only:
  - Informal
  except:
  - merge_requests

  stage: runTestINF
  script:
  - echo "$SFDX_AUTH_URL_INF" > sfdx-auth-url
  - sfdx force:auth:sfdxurl:store -f sfdx-auth-url -a INF -d
  - sfdx force:apex:test:run -u INF --testlevel=RunLocalTests -w 60

