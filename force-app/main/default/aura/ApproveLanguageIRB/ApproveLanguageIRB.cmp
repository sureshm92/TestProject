<!--
 - Created by Igor Malyuta on 22.08.2019.
 -->

<aura:component description="ApproveLanguageIRB" controller="ApprovedLangRemote"
                implements="force:hasRecordId, flexipage:availableForAllPageTypes">

    <ltng:require scripts="{!$Resource.rr_community_js}" afterScriptsLoaded="{!c.doInit}"/>

    <!--attributes-->
    <aura:attribute name="initialized" type="Boolean" default="false"/>
    <aura:attribute name="data" type="Object"/>
    <aura:attribute name="ssItems" type="List"/>
    <aura:attribute name="haveEmptyLangSS" type="Boolean"/>
    <aura:attribute name="selectedSSIds" type="String"/>

    <aura:attribute name="countryFilterType" type="String" default="All"/>
    <aura:attribute name="countryCodes" type="String"/>

    <aura:attribute name="languages" type="List"/>
    <aura:attribute name="langCodes" type="String"/>
    <aura:attribute name="langFilterType" type="String" default="All"/>

    <aura:attribute name="pageRecordsCount" type="Integer"/>
    <aura:attribute name="currentPage" type="Integer" default="1"/>
    <aura:attribute name="allRecordsCount" type="Integer"/>

    <aura:attribute name="sortOrder" type="String"/>
    <aura:attribute name="countrySortType" type="Boolean"/>
    <aura:attribute name="nameSortType" type="Boolean"/>
    <aura:attribute name="numberSortType" type="Boolean"/>

    <!--handlers: -->
    <aura:handler name="change" value="{!v.pageRecordsCount}" action="{!c.doLoadNextData}"/>
    <aura:handler name="change" value="{!v.currentPage}" action="{!c.doLoadNextData}"/>

    <!-- component body: -->
    <div class="panel">
        <c:RRSpinner aura:id="spinner"/>
        <lightning:navigation aura:id="navLink"/>

        <aura:if isTrue="{!v.initialized}">
            <!--Filters-->
            <div class="slds-m-bottom--small">
                <div class="slds-grid slds-gutters">
                    <!--Country Filter-->
                    <div class="slds-col slds-size--1-of-2">
                        <aura:if isTrue="{!equals(v.countryFilterType, 'All')}">
                            <lightning:select label="Hidden" variant="label-hidden" value="{!v.countryFilterType}"
                                              onchange="{!c.whenCountryFilterChanged}">
                                <option label="All Countries" value="All"></option>
                                <option label="Selected Countries" value="filter"></option>
                            </lightning:select>
                            <aura:set attribute="else">
                                <c:VisitResultSharingCountryLookup aura:id="countryLookup" value="{!v.countryCodes}"
                                                                   isMultiEntry="true"
                                                                   onchange="{!c.getFilteredSS}"
                                                                   placeholder="Select country"
                                                                   placeholderSelected="Select another country"
                                                                   ctpId="{!v.recordId}" includeStates="false"
                                                                   isInclude="true"/>
                            </aura:set>
                        </aura:if>
                    </div>
                    <!--Language Filter-->
                    <div class="slds-col slds-size--1-of-2">
                        <aura:if isTrue="{!equals(v.langFilterType, 'All')}">
                            <lightning:select label="Hidden" variant="label-hidden" value="{!v.langFilterType}"
                                              onchange="{!c.whenLangFilterChanged}">
                                <option label="All Languages" value="All"></option>
                                <option label="Selected Languages" value="filter"></option>
                            </lightning:select>
                            <aura:set attribute="else">
                                <c:GlobalLanguagesLookup aura:id="langsLookup" value="{!v.langCodes}"
                                                         isMultiEntry="true"
                                                         onchange="{!c.getFilteredSS}"
                                                         placeholder="Select Language"
                                                         placeholderSelected="Select another language"/>
                            </aura:set>
                        </aura:if>
                    </div>
                </div>
                <div class="slds-grid slds-gutters">
                    <!--Study Site Filter-->
                    <div class="slds-col slds-size--1-of-2">
                        <c:IRBStudySitesLookup value="{!v.selectedSSIds}" ctpId="{!v.recordId}"
                                               selectedCountries="{!v.countryCodes}"
                                               onchange="{!c.getFilteredSS}" placeholder="Select Study Site"/>
                    </div>
                    <!--Save changes button-->
                    <div class="slds-col slds-size--1-of-2 slds-p-left--small save-btn">
                        <aura:if isTrue="{!v.haveEmptyLangSS}">
                            <lightning:icon iconName="utility:warning" alternativeText="Warning!" variant="warning"
                                            size="small"/>
                            <p style="font-size: 11px; padding: 5px;">{!$Label.c.PP_IRB_SS_Empty_AppLAng}</p>
                        </aura:if>
                        <lightning:button variant="brand" label="Save" onclick="{!c.doSave}"/>
                    </div>
                </div>
            </div>
            <!--Study Site Table-->
            <div class="slds-scrollable irb-table">
                <table aria-multiselectable="true"
                       class="slds-table slds-table_cell-buffer slds-table_bordered" role="grid">
                    <thead>
                    <tr class="slds-line-height_reset">
                        <th scope="col">
                            <div data-order="country" style="display: flex" onclick="{!c.getFilteredSS}">
                                <div class="slds-truncate slds-text-align--center">
                                    Country
                                </div>
                                <div class="slds-m-left--x-small">
                                    <aura:if isTrue="{!v.countrySortType}">
                                        <lightning:icon iconName="utility:arrowdown" alternativeText=""
                                                        size="xx-small"/>
                                        <aura:set attribute="else">
                                            <lightning:icon iconName="utility:arrowup" alternativeText=""
                                                            size="xx-small"/>
                                        </aura:set>
                                    </aura:if>
                                </div>
                            </div>
                        </th>
                        <th scope="col">
                            <div data-order="name" style="display: flex" onclick="{!c.getFilteredSS}">
                                <div class="slds-truncate slds-text-align--center">
                                    Study Site
                                </div>
                                <div class="slds-m-left--x-small">
                                    <aura:if isTrue="{!v.nameSortType}">
                                        <lightning:icon iconName="utility:arrowdown" alternativeText=""
                                                        size="xx-small"/>
                                        <aura:set attribute="else">
                                            <lightning:icon iconName="utility:arrowup" alternativeText=""
                                                            size="xx-small"/>
                                        </aura:set>
                                    </aura:if>
                                </div>
                            </div>
                        </th>
                        <th class="cell-wrap" scope="col">
                            <div data-order="number" style="display: flex; align-items: center" onclick="{!c.getFilteredSS}">
                                <div>Study Site Number</div>
                                <div class="slds-m-left--x-small">
                                    <aura:if isTrue="{!v.numberSortType}">
                                        <lightning:icon iconName="utility:arrowdown" alternativeText=""
                                                        size="xx-small"/>
                                        <aura:set attribute="else">
                                            <lightning:icon iconName="utility:arrowup" alternativeText=""
                                                            size="xx-small"/>
                                        </aura:set>
                                    </aura:if>
                                </div>
                            </div>
                        </th>
                        <aura:if isTrue="{!v.languages}">
                            <aura:iteration items="{!v.languages}" var="lang">
                                <th class="" scope="col">
                                    <c:uiIndeterminatedCheckbox aura:id="columnLang" keyId="{!lang.value}"
                                                                fieldLabel="{!lang.label}"
                                                                onvaluechanged="{!c.columnCheckboxStateChange}"/>
                                </th>
                            </aura:iteration>
                        </aura:if>
                    </tr>
                    </thead>
                    <tbody>
                    <aura:if isTrue="{!v.ssItems}">
                        <aura:iteration items="{!v.ssItems}" var="item">
                            <tr class="{!if(item.emptyAppLangs, 'empty-approved-lang', '')}">
                                <th data-label="Country" scope="row">
                                    <div class="slds-truncate slds-text-align--center"
                                         title="">{!item.country.label}</div>
                                </th>
                                <td data-label="Study Site">
                                    <div class="slds-truncate slds-text-align--center" title="">
                                        <a href="javascript:void(0);" tabindex="-1" data-ssid="{!item.ss.Id}"
                                           onclick="{!c.viewStudySite}">{!item.name}</a>
                                    </div>
                                </td>
                                <td data-label="Name">
                                    <div class="slds-truncate slds-text-align--center"
                                         title="">{!item.ss.Study_Site_Number__c}</div>
                                </td>
                                <aura:iteration items="{!item.approvedLangCodes}" var="appLang">
                                    <td>
                                        <c:uiCheckbox keyId="{!item.ss.Id}" forField="{!appLang.value}"
                                                      fieldValue="{!appLang.state}"
                                                      onvaluechanged="{!c.sscCheckboxStateChange}"/>
                                    </td>
                                </aura:iteration>
                            </tr>
                        </aura:iteration>
                    </aura:if>
                    </tbody>
                </table>
            </div>
            <!--Pagination-->
            <div>
                <c:RRPaginationRemote entriesOnPage="{!v.pageRecordsCount}"
                                      currentPage="{!v.currentPage}"
                                      allRecordsCount="{!v.allRecordsCount}"/>
                <div class="padding-info">
                    <lightning:icon class="slds-m-left--x-small" iconName="utility:save" alternativeText=""
                                    variant="warning" size="small"/>
                    <p style="font-size: 11px; padding: 5px;">{!$Label.c.IRB_Padding_Info}</p>
                </div>
            </div>
        </aura:if>
    </div>
</aura:component>